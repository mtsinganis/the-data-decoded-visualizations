---
title: "Perceived levels of public sector corruption in the U.S. and Somalia Corruption Perceptions Index of US and Somalia"
date: "2025-12-07"
categories: [corruption, "Transparency International", usa, somalia]
image: plots/thumb.svg
description: "Corruption Perceptions Index (CPI) in the U.S. and Somalia (2012–2024)"
format: html
execute:
  dir: project
  echo: false
  output: false
---

## Text explaining chart

```{r project-path}

project_path <- file.path("visuals", "2025-12-us-somalia-corruption-index")

```


```{r import-data, cache=TRUE, echo=FALSE, output=FALSE}
# Load necessary libraries
library(httr)
library(readxl)
library(dplyr)

# --- Configuration ---
download_url <- "https://images.transparencycdn.org/images/CPI2024_Results-and-trends.zip"
zip_filename <- "CPI2024_Results-and-trends.zip"
# Where the data should be extracted and saved
extract_dir <- file.path(project_path, "data") 
excel_file_in_zip_pattern <- "CPI2024_Results and trends.xlsx"

# Define the full path to the final, imported Excel file
final_excel_path <- file.path(extract_dir, excel_file_in_zip_pattern)

# --- CONDITIONAL CHECK: Only proceed if the final data file is MISSING ---
if (!file.exists(final_excel_path)) {
  
  message("--- Starting Data Download and Import ---")

  # --- 1. Download the ZIP file ---
  message("1. Downloading the ZIP file...")
  
  response <- GET(download_url, 
                  write_disk(path = zip_filename, overwrite = TRUE))

  if (http_status(response)$category == "Success") {
    message("    ✅ Download complete.")
  } else {
    stop(paste("    ❌ Download failed with status:", http_status(response)$reason))
  }

  # --- 2. Extract the ZIP file ---
  message("2. Extracting the ZIP file...")

  if (!dir.exists(extract_dir)) {
    dir.create(extract_dir)
  }

  unzip_status <- unzip(zip_filename, 
                        exdir = extract_dir,
                        overwrite = TRUE)

  if (length(unzip_status) > 0) {
    message(paste("    ✅ Extracted", length(unzip_status), "files to:", extract_dir))
  } else {
    stop("    ❌ Extraction failed. Check if the ZIP file is valid.")
  }
  
  # Clean up the downloaded ZIP file
  file.remove(zip_filename)
  
} else {
  # This message will display if the file is found and we skip the download/extract steps
  message(paste("--- Skipping download: Data file found at", final_excel_path, "---"))
}

# --- 3. Import the Excel Data (Always Run) ---
# We always import the data to make sure the 'cpi_data' object is available 
# in the R session, regardless of whether it was downloaded/extracted this time.

# Find the exact Excel filename matching the pattern inside the directory
excel_filename <- list.files(extract_dir, pattern = excel_file_in_zip_pattern, full.names = FALSE)[1]
excel_path <- file.path(extract_dir, excel_filename)

message(paste("3. Importing data from:", excel_filename))

cpi_data <- read_excel(
  path = excel_path, 
  sheet = "CPI Historical", 
  skip = 2,           
  col_names = TRUE    
)

message("    ✅ Data successfully imported into 'cpi_data'.")

rm(list = ls()[!ls() %in% c("cpi_data", "project_path")])
```


```{r data-cleaning}
# Load all tidyverse packages
library(tidyverse)
library(janitor)
library(stringr)

# Clean names
cpi_data <- cpi_data %>% clean_names()

# Convert categorical variables to factors
cpi_data <- cpi_data %>% mutate(across(
  .cols = c(country_territory, iso3, region),
  .fns = factor
))

# Calculate global average
# 1. Calculate the yearly global average and prepare the new rows
global_avg_rows <- cpi_data %>%
  # Group by year to ensure the mean is calculated for each individual year
  group_by(year) %>%
  summarise(
    # Name the resulting score column 'cpi_score' to match the original data
    cpi_score = mean(cpi_score, na.rm = TRUE), 
    .groups = 'drop'
  ) %>%
  
  # 2. Add placeholder columns for line differentiation and plotting
  mutate(
    country_territory = "Global Average",
    country_territory = factor(country_territory),
    # Define plotting aesthetics for the average line
    line_color = "grey30", 
    line_width = 1.2 
  )

# 3. Combine the original data and the new global average rows
cpi_data <- bind_rows(cpi_data, global_avg_rows)

# # Check the last few rows to see the new Global Average entries
# tail(cpi_data)

# Set colors
somalia_color <- "#418FDE"
usa_color <- "#BF0A30"
global_avg_col <- "grey55"
# denmark_col <- "#789968"
other_countries_col <- alpha("#c3c3c3", alpha = 0.25)

# Add line_color and line_width specifications to differentiate US and Somalia
cpi_data <- cpi_data %>%
                mutate(line_color = case_when(
                                       country_territory == "United States of America" ~ usa_color,
                                       country_territory == "Somalia" ~ somalia_color,
                                       country_territory == "Global Average" ~ global_avg_col,
                                       # country_territory == "Denmark" ~ denmark_col,
                                       .default = other_countries_col
                                             ),
                       line_width = case_when(
                                       country_territory == "United States of America" ~ 1,
                                       country_territory == "Somalia" ~ 1,
                                       country_territory == "Global Average" ~ 1,
                                       # country_territory == "Denmark" ~ 1,
                                       .default = 0.4
                                             )
                                 )

# Ensure that the selected regions appear on top of other lines
cpi_data <- cpi_data %>% mutate(is_on_top = case_when(
  country_territory %in% c("United States of America", "Somalia", "Global Average"
                           # , "Denmark"
                           ) ~ 2,
  .default = 1
)) %>% arrange(is_on_top, country_territory, year)

country_order <- unique(cpi_data$country_territory)

cpi_data <- cpi_data %>% mutate(country_territory = factor(country_territory, levels = country_order))

# Filter the data to include ONLY the USA and Somalia at the last year (2024)
endpoint_data <- cpi_data %>%
  filter(country_territory %in% c("United States of America", "Somalia", "Global Average"
                                  # , "Denmark"
                                  ),
         year == max(year)) %>% 
  mutate(label_x = year + 0.14)

highlight_points <- cpi_data %>%
  filter(country_territory %in% c("United States of America", "Somalia", "Global Average"
                                  # , "Denmark"
                                  ))
  
  
```

```{r}
library(showtext)

font_choice <- "Momo Trust Sans"

font_choice_labels <- "Noto Serif"

font_add_google(font_choice, db_cache = FALSE)

showtext_auto()

```


```{r echo=FALSE, output=FALSE}
library(ggtext)
#source("R/theme_data_decoded.R")
# Apply theme globally
#theme_set(theme_data_decoded())

p <- ggplot(cpi_data, aes(x = year, y = cpi_score, group = country_territory)) +
      geom_line(aes(color = line_color, linewidth = line_width)) +
      geom_point(data = highlight_points, aes(x = year, y = cpi_score, color = line_color),
           size = 2, stroke = 0.5) +
      scale_linewidth_identity() +
      scale_color_identity() +
      scale_x_continuous(breaks = seq(2012, 2024, by = 1), expand = c(0.02, 0)) +
      scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100),
                         expand = expansion(mult = c(0.02, 0))) +
      coord_cartesian(clip = "off") +
      labs(x = NULL, y = NULL,
           title = paste0("<b style='color: #418FDE;'>Somalia</b> has remained at the bottom of global corruption",
             "<br>", "rankings, while the <b style='color: #BF0A30;'>United States</b> has steadily lost ground",
             "<br>", "over the past decade"),
           subtitle = paste0("Corruption Perceptions Index (CPI) based on expert and business assessments of ",
                             "public-sector", "<br>", "corruption (2012-2024). Scores range from 0 = highly corrupt to 100 = very clean."),
           caption = paste0("<b>Data source</b>: Transparency International (2025)", "<br>",
                            "<b>Note</b>: Analysis covers 2012–2024 to ensure methodological consistency, as CPI scores shifted from a 0–10 to a 0–100", "<br>", "scale starting in 2012. All 180 CPI countries are shown; only Somalia, the U.S., and the global average are highlighted.", "<br>",
                            "<b>Graphic</b>: The Data Decoded / @TheDataDecoded")
           ) +
      # Annotation Layer: Use the filtered data frame
      geom_richtext(data = endpoint_data, aes(label = c(
        # "Denmark",
        paste0("Somalia<br>(#", endpoint_data %>% filter(country_territory == "Somalia") %>% pull(rank), "/180)"),
        paste0("U.S.<br>(#", endpoint_data %>% filter(country_territory == "United States of America") %>% pull(rank), "/180)"),
        "Global<br>Average"),
                                              x = label_x, y = cpi_score, color = line_color),
                    fill = NA,
                    label.color = NA,
                    hjust = 0,         # Shift text slightly to the left of the point
                    size = 5,          # Adjust text size for visibility
                    #color = "grey50",     # Set text color
                    fontface = "bold",    # Make the labels stand out
                    show.legend = FALSE
      ) +
      theme_minimal(base_family = font_choice, base_size = 14) +
      theme(panel.grid.major.x = element_blank(),
              panel.grid.minor.x = element_blank(),
              panel.grid.major.y = element_line(linetype = 2),
              panel.grid.minor.y = element_blank(),
              axis.title.x = element_blank(),
              axis.title.y = element_blank(),
              plot.title.position = "plot",
              plot.title = element_markdown(hjust = 0, face = "bold", margin = margin(b = 5),
                                          lineheight = 1, size = rel(1.6)), # left-align title
              plot.subtitle = element_markdown(hjust = 0, margin = margin(t = 3, b = 20),
                                             size = rel(1), lineheight = 1.2), # left-align subtitle
              plot.caption.position = "plot",
              plot.caption = element_markdown(hjust = 0, vjust = 0, colour = "grey50",
                                              margin = margin(t = 20), lineheight = 1.25),
              # legend.position = c(0.947, 0.99),
              # legend.direction = "horizontal",
              # legend.justification = c(1, 1),
              plot.margin = margin(t = 18.5, r = 75, b = 13.6, l = 18.5, unit = "pt"))

svg_path <- file.path(project_path, "plots", "thumb.svg")

svg_w <- 9.4
svg_h <- 9.1

png_w <- 2000
png_h <- round(png_w * svg_h / svg_w)  # keep same aspect ratio

ggsave(svg_path, p, width = svg_w, height = svg_h)

library(rsvg)

png_path <- file.path(project_path, "plots", "us_somalia_corruption_index.png")

rsvg_png(
  svg  = svg_path,
  file = png_path,
  width  = png_w,
  height = png_h
)

```


![](plots/thumb.svg){width=100%}