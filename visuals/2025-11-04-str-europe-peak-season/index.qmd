---
title: "Short-term rental market peak season by world region"
date: "2025-11-04"
categories: [STR, Europe, occupancy]
image: plots/thumb.svg
description: "Peaks of monthly available listings and occupancy in world regions based on AirDNA data"
format: html
execute:
  dir: project
  echo: false
  output: false
---

## Text explaining chart

```{r echo=FALSE, output=FALSE}
#| cache: false

# Load required packages
library(tidyverse)

project_path <- file.path("visuals", "2025-11-04-str-europe-peak-season")

# List all CSV files
files <- list.files(paste0(project_path, "/data"), pattern = "\\.csv$", full.names = TRUE)

# Extract ISO2 from filenames (e.g., "market_summary_ES.csv" -> "ES")
file_key <- tibble(
  file = files,
  ISO2 = toupper(stringr::str_match(files, paste0(project_path, "/data/market-summary-([A-Za-z]{2})\\.csv"))[,2])
)

# Read lookup table
iso_lookup <- read_csv("lookups/country_ISO_codes.csv", show_col_types = FALSE) |>
  rename(ISO2 = "Code") |>
  rename(country = "Name")

# Read UNWTO country → region mapping

encoding <- guess_encoding("lookups/unwto_country_region_mapping.csv")["encoding"]

unwto_map <- read_csv("lookups/unwto_country_region_mapping.csv",
                      show_col_types = FALSE,
                      locale = locale(encoding = paste(encoding))) %>%
  janitor::clean_names() %>%
  rename(
    world_region = region,      # rename for clarity
    world_subregion = subregion # keep subregion if you want to facet later
  ) %>%
  mutate(
    country = trimws(country),
    world_region = trimws(world_region)
  )

# Add ISO2 to UNWTO via countrycode, then patch edge cases ---
library(countrycode)

unwto_map <- unwto_map %>%
  mutate(
    ISO2 = countrycode(country, origin = "country.name", destination = "iso2c")
  )

# Manual patches for the known problematic names
fix_iso <- tribble(
  ~country,                                        ~ISO2,
  "Bolivia, Plurinational State of",               "BO",
  "Curaçao",                                       "CW",
  "Korea, Republic of",                            "KR",
  "Lao People's Democratic Republic",              "LA",
  "Macedonia, the Former Yugoslav Republic of",    "MK",  # (North Macedonia; ISO2 still MK)
  "Turkey",                                        "TR",  # or "Türkiye" -> TR
  "Taiwan, Province of China",                     "TW",
  "Tanzania, United Republic of",                  "TZ",
  "Venezuela, Bolivarian Republic of",             "VE"
)

unwto_map <- unwto_map %>%
  left_join(fix_iso, by = "country", suffix = c("", "_fix")) %>%
  mutate(ISO2 = coalesce(ISO2_fix, ISO2)) %>%
  select(-ISO2_fix)

unwto_map <- unwto_map %>% bind_rows(tibble(country = "Europe",
                               world_region = "Europe",
                               world_subregion = NA,
                               ISO2 = "EU"))

# (Optional) sanity check: which UNWTO rows still lack ISO2?
still_na <- unwto_map %>% filter(is.na(ISO2))
if (nrow(still_na)) {
  warning("UNWTO rows without ISO2: ", paste(still_na$country, collapse = ", "))
}


# Helper function to read a single file and tag ISO2
read_one <- function(path, iso2) {
  
  country_name <- unwto_map |> 
    filter(ISO2 == iso2) |> 
    pull(country)
  
  read_csv(path, show_col_types = FALSE) |>
    janitor::clean_names() |>
    mutate(ISO2 = iso2, country = country_name)
}

# Read and combine all files using modern purrr syntax
all_data <- map2(file_key$file, file_key$ISO2, read_one) |>
  list_rbind()
```

```{r}
library(lubridate)

all_data <- all_data %>%
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>%
  relocate(month, .after = date)

```

```{r}
# Add world_region to all_data (join by country) ---
# (Assumes all_data already has a 'country' column; if not, join by ISO2 if present in the mapping)

all_data <- all_data %>%
  left_join(unwto_map %>% select(ISO2, world_region, world_subregion), by = "ISO2")

# verify coverage
missing_after_join <- all_data %>% filter(is.na(world_region)) %>% distinct(ISO2)
if (nrow(missing_after_join)) {
  warning("No UNWTO region for ISO2: ", paste(missing_after_join$ISO2, collapse = ", "))
}

# Normalize occupancy
all_data <- all_data %>%
  group_by(country) %>%
  mutate(occ_norm = (occupancy - min(occupancy, na.rm = TRUE)) /
                    (max(occupancy, na.rm = TRUE) - min(occupancy, na.rm = TRUE))) %>%
  # mutate(occ_norm_index = occupancy / max(occupancy, na.rm = TRUE)) %>% # Index-to-peak normalization (relative to annual max)
  # mutate(occ_z = (occupancy - mean(occupancy, na.rm = TRUE)) /
  #                sd(occupancy, na.rm = TRUE)) %>% # Z-score standardization
  # mutate(occ_share = occupancy / sum(occupancy, na.rm = TRUE)) %>% # Share of yearly total
  ungroup()

# Top 25 European countries (>10k average listings in 2024)
europe_top_25 <- all_data %>% filter(world_region == "Europe") %>% group_by(country) %>%
    summarise(average_listings = mean(active_listings)) %>% 
    arrange(desc(average_listings)) %>%
    # mutate(rank = 1:40)
    top_n(25) %>% pull(country)

# Create folder for generated datasets
if (!dir.exists(paste0(project_path, "/data/derived")))
dir.create(paste0(project_path, "/data/derived"), recursive = TRUE)

# Save combined dataset
write_csv(all_data, paste0(project_path, "/data/derived/combined_countries.csv"))
```


```{r}
library(forcats)

# Drop unnecessary columns and convert to wide format
europe_wide <- all_data %>%
    filter(country %in% europe_top_25) %>% 
    select(month, country, occ_norm) %>% 
    pivot_wider(names_from = month, values_from = occ_norm) 

# Compute average per month  
europe_avg <- europe_wide %>%
    summarise(across(Jan:Dec, ~ mean(.x, na.rm = TRUE))) %>%
    mutate(country = "Europe")
    
# Append the new row to the existing dataframe
europe_wide <- bind_rows(europe_wide, europe_avg) %>%
    relocate(country)  # move 'country' to the first column

# Compute combined Jul and Aug occupancy score per country
country_rank <- europe_wide %>% 
    rowwise() %>% 
    summarise(country = country,
              month_choice = sum(c(Jul))) %>% # originally a sum of Jul and Aug
    arrange(month_choice) %>% 
    mutate(country = factor(country, levels = country))

# Need to move Europe as the last level
other_levels <- levels(country_rank$country)[levels(country_rank$country) != "Europe"]
new_levels <- c(other_levels, "Europe")

country_rank <- country_rank %>% mutate(country = factor(country, levels = new_levels))

# Convert data frame back to long format for use in ggplot
europe_long <- europe_wide %>% 
    pivot_longer(cols = Jan:Dec, names_to = "month", values_to = "occ_norm") %>% 
    mutate(month = factor(month, levels = month.abb),
           group = case_when(
               country == "Europe" ~ "Europe",
               .default = "Other"
           ))

# Add back an iso2 column to match the country flag codes
europe_long <- europe_long %>% 
  left_join(unwto_map %>% select(country, ISO2), by = "country") %>% 
  mutate(country = factor(country, levels = new_levels))
  
```

```{r country-flags}
library(rsvg)

country_flags <- tibble(ISO2 = unique(europe_long$ISO2),
                        flag_url = paste0("https://hatscripts.github.io/circle-flags/flags/",
                                              tolower(unique(europe_long$ISO2)),
                                              ".svg")) %>% 
                left_join(unwto_map %>% select(country, ISO2), by = "ISO2") %>% 
                mutate(country = factor(country, levels = new_levels))

# Create new folder for flags (inside 'data')
if (!dir.exists(paste0(project_path, "/data/country_flags")))
dir.create(paste0(project_path, "/data/country_flags"), recursive = TRUE)

country_flags <- country_flags %>%
                    mutate(local_svg_file = paste0(project_path, "/data/country_flags/", tolower(ISO2), ".svg"),
                           png_file = paste0(project_path, "/data/country_flags/", tolower(ISO2), ".png"))

# Iteratively download images from https://hatscripts.github.io/circle-flags/gallery.html
# Flags are in SVG
purrr::walk2(
  .x = country_flags$flag_url, # The URLs to download (source)
  .y = country_flags$local_svg_file, # The file path to save to (destination)
  .f = download.file,
  quiet = TRUE,
  mode = "wb" # Use "wb" (write binary) for images to prevent corruption
)

# Convert flags from SVG to PNG for plotting with ggplot
purrr::walk2(
  .x = country_flags$local_svg_file,
  .y = country_flags$png_file,
  .f = rsvg_png
)

country_flags <- country_flags %>% 
                  mutate(x_pos = -0.21,
                         y_pos = as.numeric(country),
                         group = case_when(
                                           country == "Europe" ~ "Europe",
                                           .default = "Other"
                                          ),
                        y_pos = if_else(country == "Europe",
                                        1,           
                                        y_pos        
                                       )
                        )

```

```{r}
library(showtext)
font_choice <- "Momo Trust Sans"

font_add_google(font_choice, db_cache = FALSE)
showtext_auto()
```


```{r}

# library(heatmaply)
library(ggtext)
library(viridisLite)
library(glue)
library(ggimage)


# labels for top of chart
top_labels <- expand_grid(
  month  = levels(europe_long$month),
  group  = "Europe"
) %>%
  mutate(label = month)

# Find hex color of max value of 
col_max <- tail(plasma(256), 1)   # yellow end of the scale

# title_html <- glue(
#   "July and August are ",
#   "<span style='background-color:{col_max}; padding:2px 4px; display: inline-block;'>",
#   "peak months</spanb> in all of Europe’s",
#   "<br/>top markets"  # use <br/> with element_markdown
# )

title_html <- paste0("July and August are ", "peak months in Europe's top",
                     "\n", "top short-term rental markets independent of latitude")

# 1. Define the number of months (12)
months_factor_levels <- levels(europe_long$month)
month_names <- months_factor_levels[1:12] # Get all 12 month names

# 2. Define the large Y-position for the invisible row (e.g., 5 or 10)
# This will push the plot's coordinate system boundary up from y=1 to y=5 (or 10)
DUMMY_Y_POSITION <- 2 

# 3. Create the dummy data frame
dummy_data_y_expansion <- tibble(
  # Include all columns necessary for the geom and faceting
  country = "", 
  month = factor(month_names, levels = months_factor_levels),
  occ_norm = NA_real_, # Invisible data
  group = "Europe",    # Belongs to the top facet
  ISO2 = "EU",
  # Set the Y position to the expanded limit
  dummy_y_pos = DUMMY_Y_POSITION 
)

# Get the month positions for Jul/Aug
jul_pos <- which(levels(europe_long$month) == "Jul") - 0.5
aug_pos <- which(levels(europe_long$month) == "Aug") + 0.5

# 1. Data for the TOP Facet ("Europe") - Fixed Height
rect_top_data <- data.frame(
  group = "Europe",
  xmin = jul_pos,
  xmax = aug_pos,
  ymin = 0.5,  # Covers the 'Europe' row (which is at y=1)
  ymax = 1.5   # Stops exactly at the top of the 'Europe' tile
)

# 2. Data for the BOTTOM Facet ("Other") - Full Height
rect_bottom_data <- data.frame(
  group = "Other",
  xmin = jul_pos,
  xmax = aug_pos,
  ymin = 0.5, # Goes to the bottom boundary of the facet
  ymax = nrow(country_flags) - 0.5   # Goes to the top boundary of the facet
)

# Combine them into a single data frame
rect_data_combined <- bind_rows(rect_top_data, rect_bottom_data)


base_size <- 12

p <- ggplot(europe_long, aes(x = month, y = country, fill = occ_norm)) +
        geom_tile() +
        geom_tile(data = dummy_data_y_expansion, 
              aes(x = month, y = country), fill = NA) + # Use alpha=0 or fill=NA to hide it
        facet_grid(group ~ ., scales = "free_y", space = "free_y") +
        # scale_fill_gradient(low = "#deebf7", high = "#192951") +
        scale_fill_viridis_c(option = "plasma", direction = 1, name = "Normalized\nOccupancy (0–1)",) +
        # scale_fill_gradientn(colors = heatmaply::cool_warm(500), limits = c(0,1)) +  # cool-warm scale
        #coord_fixed() +
        labs(
          x = NULL, y = NULL,
          title = title_html,
          subtitle = "Normalized monthly occupancy by country (Jan–Dec 2024)",
          caption = "Data source: AirDNA (2025)"
        ) +

        geom_rect(
          data = rect_data_combined,
          aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
          color = "black",
          fill = NA,
          linewidth = 0.65,
          inherit.aes = FALSE # Essential when using external data
        ) +
  
        scale_x_discrete(expand = expansion(mult = c(0.15, 0.05))) +
        # scale_y_discrete(expand = expansion(mult = c(0, 0.1))) +
                         
        geom_text(data = top_labels, aes(x = month, y = DUMMY_Y_POSITION - 0.5, label = label),
          inherit.aes = FALSE, vjust = -0.75, size = 3.2, family = font_choice,
          colour = "grey30") +
  
        # Layer 1: Flag for the "Europe" facet
        geom_image(
          data = country_flags %>% filter(country == "Europe"), # Only contains 'Europe' row
          aes(x = x_pos, y = y_pos, image = flag_url),
          size = 0.38,
          asp = 1,
          inherit.aes = FALSE
        ) +
      
        # Layer 2: Flags for the "Other" facet
        geom_image(
          data = country_flags %>% filter(!country == "Europe"), # Contains all other country rows
          aes(x = x_pos, y = y_pos, image = flag_url),
          size = 0.03,
          asp = 1,
          inherit.aes = FALSE
        ) +

        theme_minimal(base_family = font_choice, base_size = 12) +
        theme(
          panel.grid = element_blank(),
          panel.spacing.y = unit(10, "pt"),
          # strip.text.y = element_text(face = "bold", angle = 0),
          strip.text = element_blank(),      # hides the panel text labels
          # strip.background = element_blank(), # removes the background panel
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          axis.text.y = element_text(hjust = 1, margin = margin(r = 1.8)),
          plot.title.position = "plot",  # ensures alignment relative to full plot
          plot.title = element_text(hjust = 0, face = "bold", margin = margin(b = 5),
                                    lineheight = 1, size = rel(1.6)), # left-align title
          plot.subtitle = element_text(hjust = 0, margin = margin(t = 3, b = 16),
                                       size = rel(1.2)), # left-align subtitle
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0, vjust = -3, colour = "grey50"),
          legend.title = element_text(lineheight = 1, margin = margin(b = 20, unit = "pt")),
          legend.margin = margin(l = 4)
        )

# Save thumbnail for homepage listing

if (!dir.exists(paste0(project_path, "/plots")))
dir.create(paste0(project_path, "/plots"), recursive = TRUE)

plot_path <- paste0(project_path, "/plots", "/thumb.svg")

ggsave(plot_path, p, width = 6.7, height = 8.2)
```








```{r temp}
ggplot(europe_long, aes(x = month, y = country, fill = occ_norm)) +
        geom_tile() +
        facet_grid(group ~ ., scales = "free_y", space = "free_y") +
        # scale_fill_gradient(low = "#deebf7", high = "#192951") +
        scale_fill_viridis_c(option = "plasma", direction = 1, name = "Normalized\nOccupancy (0–1)",) +
        # scale_fill_gradientn(colors = heatmaply::cool_warm(500), limits = c(0,1)) +  # cool-warm scale
        #coord_fixed() +
        labs(
          x = NULL, y = NULL,
          title = title_html,
          subtitle = "Normalized monthly occupancy by country (Jan–Dec 2024)",
          caption = "Data source: AirDNA (2025)"
        ) +
        annotate(
          "rect",
          xmin = which(levels(europe_long$month) == "Jul") - 0.5,
          xmax = which(levels(europe_long$month) == "Aug") + 0.5,
          ymin = -Inf, ymax = Inf,
          color = "black",
          fill = NA,
          linewidth = 0.65
        ) +
        scale_x_discrete(expand = expansion(mult = c(0.14, 0.05))) +
                         
        geom_text(data = top_labels, aes(x = month, y = Inf, label = label),
          inherit.aes = FALSE, vjust = -0.9, size = 7, family = font_choice,
          colour = "grey30") +
        # Layer 1: Flag for the "Europe" facet
        geom_image(
          data = country_flags %>% filter(country == "Europe"), # Only contains 'Europe' row
          aes(x = x_pos, y = y_pos, image = flag_url),
          size = 0.65,
          asp = 1,
          inherit.aes = FALSE
        ) +
      
        # Layer 2: Flags for the "Other" facet
        geom_image(
          data = country_flags %>% filter(!country == "Europe"), # Contains all other country rows
          aes(x = x_pos, y = y_pos, image = flag_url),
          size = 0.03,
          asp = 1,
          inherit.aes = FALSE
        ) +
        # geom_image(data = country_flags,
        #            aes(x = x_pos,
        #                y = y_pos,
        #                image = png_file),
        #            size = 0.06,
        #            inherit.aes = FALSE) +
  
        theme_minimal(base_family = font_choice, base_size = 32) +
        theme(
          panel.grid = element_blank(),
          # strip.text.y = element_text(face = "bold", angle = 0),
          strip.text = element_blank(),      # hides the panel text labels
          strip.background = element_blank(), # removes the background panel
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          axis.text.y = element_text(hjust = 1, margin = margin(r = )),
          plot.title.position = "plot",  # ensures alignment relative to full plot
          plot.title = element_text(hjust = 0, face = "bold", margin = margin(b = 0),
                                    lineheight = 0.33, size = 52), # left-align title
          plot.subtitle = element_text(hjust = 0, margin = margin(t = 3, b = 15),
                                       size = 37), # left-align subtitle
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0, colour = "grey50"),
          legend.title = element_text(lineheight = 0.4),
          legend.margin = margin(l = -5, unit = "pt")
        )
```



![Figure caption](plots/thumb.png){width=100%}
```{r}
#| output: true
# print(p)
```

